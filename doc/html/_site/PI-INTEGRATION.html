<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>PI-INTEGRATION.mathjax_tmp</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styles.css" />
  
  <script>
  window.MathJax = {
    loader: {
      load: ['[tex]/ams']
    },
    tex: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['ams']},
      macros: {
        dd: '{\\,\\mathrm{d}}',
        degC: '{^{\\circ}\\!\\mathrm{C}}',
        Ohm: '{\\,\\Omega}',
        ohm: '{\\,\\Omega}',
        degree: '{^{\\circ}}'
      }
    },
    options: {
      skipHtmlTags: ['script','noscript','style','textarea','pre','code','kbd','samp']
    }
  };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="main-container">
<h1 id="selection-panel-raspberry-pi-integration-phase-7">Selection
Panel: Raspberry Pi Integration (Phase 7)</h1>
<p>Version 2.5.2 | Raspberry Pi 5 + ESP32-S3 | Stand: 2026-01-08</p>
<h2 id="übersicht">Übersicht</h2>
<p>In Phase 7 wird der ESP32-S3 zum reinen I/O-Controller. Der Raspberry
Pi 5 übernimmt die Anwendungslogik: Er empfängt Taster-Events über
Serial, sendet sie per WebSocket an das Web-Dashboard und steuert bei
Bedarf die LEDs.</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           RASPBERRY PI 5                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      server.py (aiohttp)                            │    │
│  │                                                                     │    │
│  │   Serial-Thread ◀────────────▶ Asyncio Event Loop                   │    │
│  │        │                              │                             │    │
│  │        ▼                              ▼                             │    │
│  │   PRESS 001 ──────────────▶ WebSocket Broadcast                     │    │
│  │                           {&quot;type&quot;:&quot;play&quot;,&quot;id&quot;:1}                    │    │
│  └─────────────────────────────────────┬───────────────────────────────┘    │
│                                        │                                    │
│              ┌─────────────────────────┼─────────────────────────┐          │
│              │                         │                         │          │
│              ▼                         ▼                         ▼          │
│         /static/               /ws (WebSocket)              /media/         │
│         app.js, CSS            Browser-Clients              001.jpg/.mp3    │
│                                                                             │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                      USB-CDC @ 115200 Baud (by-id Pfad)
                                          │
┌─────────────────────────────────────────┴───────────────────────────────────┐
│                           ESP32-S3 (XIAO)                                   │
│                                                                             │
│   PRESS/RELEASE Events ──────────────▶ Serial TX                            │
│   LED-Steuerung ◀──────────────────── Serial RX (LEDSET, optional)          │
│                                                                             │
│   Hinweis: ESP32 setzt LED bei Tastendruck selbst (ESP32_SETS_LED_LOCALLY)  │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h2 id="serial-verbindung">Serial-Verbindung</h2>
<h3 id="stabiler-device-pfad-by-id">Stabiler Device-Pfad (by-id)</h3>
<p>Der ESP32-S3 erscheint als USB-CDC-Gerät. Der Pfad
<code>/dev/ttyACM0</code> kann sich nach Reboot ändern. Die Lösung:
Verwende den stabilen by-id Pfad:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilen Pfad ermitteln</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /dev/serial/by-id/</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># → usb-Espressif_USB_JTAG_serial_debug_unit_98:3D:AE:EA:08:1C-if00 -&gt; ../../ttyACM0</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dieser Pfad bleibt stabil</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">SERIAL_PORT</span><span class="op">=</span><span class="st">&quot;/dev/serial/by-id/usb-Espressif_USB_JTAG_serial_debug_unit_98:3D:AE:EA:08:1C-if00&quot;</span></span></code></pre></div>
<h3 id="berechtigungen">Berechtigungen</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Benutzer zur dialout-Gruppe hinzufügen</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> usermod <span class="at">-aG</span> dialout <span class="va">$USER</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ausloggen und wieder einloggen!</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Verbindung testen</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">screen</span> <span class="va">$SERIAL_PORT</span> 115200</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># → READY</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># → FW SelectionPanel v2.5.2</span></span></code></pre></div>
<h2 id="server-architektur">Server-Architektur</h2>
<h3 id="komponenten">Komponenten</h3>
<p>Der Python-Server (<code>server.py</code>) verwendet
<strong>aiohttp</strong> für asynchrone HTTP/WebSocket-Verarbeitung:</p>
<table class="table table-compact">
<thead>
<tr>
<th>Komponente</th>
<th>Technologie</th>
<th>Funktion</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP-Server</td>
<td>aiohttp</td>
<td>Statische Dateien, API-Endpoints</td>
</tr>
<tr>
<td>WebSocket</td>
<td>aiohttp</td>
<td>Echtzeit-Kommunikation mit Browser</td>
</tr>
<tr>
<td>Serial-Reader</td>
<td>Threading</td>
<td>Liest ESP32-Events im Hintergrund</td>
</tr>
<tr>
<td>Media-Validator</td>
<td>Startup</td>
<td>Prüft ob alle Medien vorhanden</td>
</tr>
</tbody>
</table>
<h3 id="http-endpoints">HTTP-Endpoints</h3>
<table class="table table-compact">
<thead>
<tr>
<th>Endpoint</th>
<th>Methode</th>
<th>Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/</code></td>
<td>GET</td>
<td>Web-Dashboard (index.html)</td>
</tr>
<tr>
<td><code>/ws</code></td>
<td>WebSocket</td>
<td>Echtzeit-Events</td>
</tr>
<tr>
<td><code>/static/</code></td>
<td>GET</td>
<td>JavaScript, CSS, Favicon</td>
</tr>
<tr>
<td><code>/media/</code></td>
<td>GET</td>
<td>Bilder und Audio (001.jpg, 001.mp3)</td>
</tr>
<tr>
<td><code>/status</code></td>
<td>GET</td>
<td>Server-Status als JSON</td>
</tr>
<tr>
<td><code>/health</code></td>
<td>GET</td>
<td>Health-Check (für Monitoring)</td>
</tr>
<tr>
<td><code>/test/play/{id}</code></td>
<td>GET</td>
<td>Simuliert Tastendruck</td>
</tr>
<tr>
<td><code>/test/stop</code></td>
<td>GET</td>
<td>Stoppt Wiedergabe</td>
</tr>
</tbody>
</table>
<h3 id="konfiguration">Konfiguration</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># server.py - Wichtige Einstellungen</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>VERSION <span class="op">=</span> <span class="st">&quot;2.5.2&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Build-Modus</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>PROTOTYPE_MODE <span class="op">=</span> <span class="va">True</span>   <span class="co"># True = 10 Medien, False = 100 Medien</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>NUM_MEDIA <span class="op">=</span> <span class="dv">10</span> <span class="cf">if</span> PROTOTYPE_MODE <span class="cf">else</span> <span class="dv">100</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Serial-Port (stabiler by-id Pfad!)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>SERIAL_PORT <span class="op">=</span> <span class="st">&quot;/dev/serial/by-id/usb-Espressif_USB_JTAG_serial_debug_unit_98:3D:AE:EA:08:1C-if00&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>SERIAL_BAUD <span class="op">=</span> <span class="dv">115200</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># HTTP-Server</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>HTTP_HOST <span class="op">=</span> <span class="st">&quot;0.0.0.0&quot;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>HTTP_PORT <span class="op">=</span> <span class="dv">8080</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ESP32 setzt LED selbst bei Tastendruck</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>ESP32_SETS_LED_LOCALLY <span class="op">=</span> <span class="va">True</span></span></code></pre></div>
<h2 id="websocket-protokoll">WebSocket-Protokoll</h2>
<p>Die Kommunikation zwischen Server und Browser erfolgt über
WebSocket:</p>
<h3 id="server-browser">Server → Browser</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Wiedergabe</span> <span class="er">starten</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;play&quot;</span><span class="fu">,</span> <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">}</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Wiedergabe</span> <span class="er">stoppen</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;stop&quot;</span><span class="fu">}</span></span></code></pre></div>
<h3 id="browser-server">Browser → Server</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Audio</span> <span class="er">beendet</span> <span class="er">(für</span> <span class="er">LED-Clear)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ended&quot;</span><span class="fu">,</span> <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Heartbeat</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ping&quot;</span><span class="fu">}</span></span></code></pre></div>
<h2 id="serial-protokoll-esp32-pi">Serial-Protokoll (ESP32 ↔︎ Pi)</h2>
<h3 id="esp32-pi">ESP32 → Pi</h3>
<table class="table table-compact">
<thead>
<tr>
<th>Nachricht</th>
<th>Bedeutung</th>
<th>Beispiel</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>READY</code></td>
<td>ESP32 bereit</td>
<td><code>READY</code></td>
</tr>
<tr>
<td><code>FW &lt;version&gt;</code></td>
<td>Firmware-Version</td>
<td><code>FW SelectionPanel v2.5.2</code></td>
</tr>
<tr>
<td><code>PRESS &lt;id&gt;</code></td>
<td>Taster gedrückt</td>
<td><code>PRESS 001</code></td>
</tr>
<tr>
<td><code>RELEASE &lt;id&gt;</code></td>
<td>Taster losgelassen</td>
<td><code>RELEASE 001</code></td>
</tr>
<tr>
<td><code>PONG</code></td>
<td>Antwort auf PING</td>
<td><code>PONG</code></td>
</tr>
<tr>
<td><code>OK</code></td>
<td>Befehl ausgeführt</td>
<td><code>OK</code></td>
</tr>
</tbody>
</table>
<h3 id="pi-esp32">Pi → ESP32</h3>
<table class="table table-compact">
<colgroup>
<col style="width: 23%" />
<col style="width: 32%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Befehl</th>
<th>Bedeutung</th>
<th>Wann gesendet</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LEDSET &lt;id&gt;</code></td>
<td>One-Hot LED</td>
<td>Nur wenn <code>ESP32_SETS_LED_LOCALLY=False</code></td>
</tr>
<tr>
<td><code>LEDCLR</code></td>
<td>Alle LEDs aus</td>
<td>Nach Audio-Ende</td>
</tr>
<tr>
<td><code>PING</code></td>
<td>Verbindungstest</td>
<td>Bei Bedarf</td>
</tr>
</tbody>
</table>
<p><strong>Wichtig:</strong> Mit
<code>ESP32_SETS_LED_LOCALLY=True</code> setzt der ESP32 die LED bei
Tastendruck selbst. Der Server muss dann nur noch <code>LEDCLR</code>
nach Audio-Ende senden.</p>
<h2 id="datenfluss">Datenfluss</h2>
<pre><code>Taster 3 gedrückt
       │
       ▼
┌──────────────┐
│   ESP32-S3   │
│ • Entprellt  │
│ • LED 3 an   │ ←── ESP32 setzt LED selbst!
│ • Serial TX  │
└──────┬───────┘
       │ &quot;PRESS 003\n&quot;
       ▼
┌──────────────┐
│  server.py   │
│ Serial-Thread│
└──────┬───────┘
       │ asyncio Queue
       ▼
┌──────────────┐
│ Event Loop   │
│ • Broadcast  │
└──────┬───────┘
       │ {&quot;type&quot;:&quot;play&quot;,&quot;id&quot;:3}
       ▼
┌──────────────┐
│   Browser    │
│ • Bild laden │
│ • Audio play │
└──────────────┘
       │
       │ Audio endet
       ▼
┌──────────────┐
│   Browser    │
│ • ended senden│
└──────┬───────┘
       │ {&quot;type&quot;:&quot;ended&quot;,&quot;id&quot;:3}
       ▼
┌──────────────┐
│  server.py   │
│ • LEDCLR TX  │
└──────┬───────┘
       │ &quot;LEDCLR\n&quot;
       ▼
┌──────────────┐
│   ESP32-S3   │
│ • Alle LEDs  │
│   aus        │
└──────────────┘</code></pre>
<h2 id="web-dashboard">Web-Dashboard</h2>
<h3 id="features">Features</h3>
<p>Das Dashboard (<code>index.html</code> + <code>app.js</code>)
bietet:</p>
<ul>
<li><strong>Audio-Unlock</strong>: Button zum Entsperren der
Browser-Autoplay-Policy</li>
<li><strong>Medien-Preload</strong>: Lädt alle Bilder/Audio nach Unlock
vor</li>
<li><strong>Echtzeit-Anzeige</strong>: Aktuelles Bild +
Audio-Fortschritt</li>
<li><strong>Keyboard-Shortcuts</strong>: Space = Play/Pause, Ctrl+D =
Debug</li>
<li><strong>Debug-Panel</strong>: Zeigt alle Events (ausklappbar)</li>
</ul>
<h3 id="zugriff">Zugriff</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Server starten</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/pi/selection-panel</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> server.py</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Browser öffnen</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Lokal:   http://localhost:8080/</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># LAN:     http://rover:8080/</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># IP:      http://192.168.1.24:8080/</span></span></code></pre></div>
<h3 id="status-api">Status-API</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Server-Status abfragen</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://rover:8080/status <span class="kw">|</span> <span class="ex">jq</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;version&quot;</span><span class="ex">:</span> <span class="st">&quot;2.5.2&quot;</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mode&quot;</span><span class="ex">:</span> <span class="st">&quot;prototype&quot;</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;num_media&quot;</span><span class="ex">:</span> 10,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;current_button&quot;</span><span class="ex">:</span> null,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;ws_clients&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;serial_connected&quot;</span><span class="ex">:</span> true,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;serial_port&quot;</span><span class="ex">:</span> <span class="st">&quot;/dev/serial/by-id/...&quot;</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;media_missing&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;esp32_local_led&quot;</span><span class="ex">:</span> true</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h2 id="usb-port-verwaltung-amr-koexistenz">USB-Port-Verwaltung
(AMR-Koexistenz)</h2>
<p>Auf dem Pi läuft auch das AMR-Projekt, das denselben ESP32-Port
nutzen kann. Ein <strong>flock-basiertes Locking</strong> verhindert
Konflikte:</p>
<h3 id="lock-mechanismus">Lock-Mechanismus</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lock-Datei</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/var/lock/esp32-serial.lock</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Selection Panel: Non-blocking (startet nicht wenn belegt)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">flock</span> <span class="at">-n</span> /var/lock/esp32-serial.lock python3 server.py</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># AMR Agent: Blocking (wartet bis frei)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ex">flock</span> /var/lock/esp32-serial.lock micro_ros_agent ...</span></code></pre></div>
<h3 id="schneller-wechsel">Schneller Wechsel</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># → Selection Panel Modus</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl stop selection-panel.service  <span class="co"># Falls AMR läuft</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl start selection-panel.service</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> journalctl <span class="at">-u</span> selection-panel.service <span class="at">-f</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># → AMR Modus</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl stop selection-panel.service</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/pi/amr/docker</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker compose <span class="at">-p</span> docker up <span class="at">-d</span> microros_agent</span></code></pre></div>
<h3 id="kontrolle">Kontrolle</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wer hält den USB-Port?</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> fuser <span class="at">-v</span> /dev/ttyACM0</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Wer hält den Lock?</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> lslocks <span class="kw">|</span> <span class="fu">grep</span> esp32-serial</span></code></pre></div>
<h2 id="systemd-service">systemd-Service</h2>
<h3 id="service-datei">Service-Datei</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode ini"><code class="sourceCode ini"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/systemd/system/selection-panel.service</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[Unit]</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ot">=</span><span class="st">Selection Panel Server</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ot">=</span><span class="st">network.target</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Type</span><span class="ot">=</span><span class="st">simple</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ot">=</span><span class="st">pi</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="dt">WorkingDirectory</span><span class="ot">=</span><span class="st">/home/pi/selection-panel</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># flock -n: Startet nur wenn Lock frei</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ot">=</span><span class="st">/usr/bin/flock -n /var/lock/esp32-serial.lock /usr/bin/python3 server.py</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ot">=</span><span class="st">on-failure</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="dt">RestartSec</span><span class="ot">=</span><span class="dv">5</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">[Install]</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ot">=</span><span class="st">multi-user.target</span></span></code></pre></div>
<h3 id="aktivierung">Aktivierung</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Service registrieren</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl daemon-reload</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Manueller Start</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl start selection-panel.service</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Autostart aktivieren</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable selection-panel.service</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Status prüfen</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl status selection-panel.service</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Logs verfolgen</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="ex">journalctl</span> <span class="at">-u</span> selection-panel.service <span class="at">-f</span></span></code></pre></div>
<h2 id="medien-struktur">Medien-Struktur</h2>
<pre><code>media/
├── 001.jpg    # Bild für Taster 1
├── 001.mp3    # Audio für Taster 1
├── 002.jpg
├── 002.mp3
├── ...
├── 010.jpg
└── 010.mp3</code></pre>
<h3 id="validierung-beim-start">Validierung beim Start</h3>
<p>Der Server prüft beim Start ob alle erwarteten Medien vorhanden
sind:</p>
<pre><code>2026-01-08 [INFO] Medien-Validierung: 10/10 vollständig

# Oder bei fehlenden Dateien:
2026-01-08 [WARNING] Fehlende Medien: 2 Dateien
2026-01-08 [WARNING]   - 005.jpg
2026-01-08 [WARNING]   - 005.mp3</code></pre>
<h3 id="test-medien-generieren">Test-Medien generieren</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dummy-Medien für Tests erstellen</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/pi/selection-panel</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./scripts/generate_test_media.sh</span></span></code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="esp32-nicht-erkannt">ESP32 nicht erkannt</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># USB-Geräte auflisten</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lsusb</span> <span class="kw">|</span> <span class="fu">grep</span> Espressif</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># → Espressif USB JTAG/serial debug unit</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Device-Pfad prüfen</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /dev/serial/by-id/</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> /dev/ttyACM<span class="pp">*</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Falls Pfad geändert: In server.py anpassen</span></span></code></pre></div>
<h3 id="keine-ready-nachricht">Keine READY-Nachricht</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Serial direkt testen</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">screen</span> /dev/ttyACM0 115200</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ESP32 per Reset-Taste neu starten</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># → READY sollte erscheinen</span></span></code></pre></div>
<h3 id="websocket-verbindet-nicht">WebSocket verbindet nicht</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Server läuft?</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl status selection-panel.service</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Port offen?</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ss</span> <span class="at">-tlnp</span> <span class="kw">|</span> <span class="fu">grep</span> 8080</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Firewall?</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 8080/tcp</span></code></pre></div>
<h3 id="audio-spielt-nicht">Audio spielt nicht</h3>
<ol type="1">
<li>“Sound aktivieren” Button im Browser klicken</li>
<li>Browser-Konsole auf Fehler prüfen (F12)</li>
<li>Medien-Dateien vorhanden? → <code>/status</code> Endpoint
prüfen</li>
</ol>
<h3 id="port-konflikt-mit-amr">Port-Konflikt mit AMR</h3>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wer nutzt den Port?</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> fuser <span class="at">-v</span> /dev/ttyACM0</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Selection Panel stoppen</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl stop selection-panel.service</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Lock prüfen</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> lslocks <span class="kw">|</span> <span class="fu">grep</span> esp32-serial</span></code></pre></div>
<h2 id="latenz-analyse">Latenz-Analyse</h2>
<table class="table table-compact">
<thead>
<tr>
<th>Station</th>
<th>Typische Latenz</th>
</tr>
</thead>
<tbody>
<tr>
<td>Taster → ESP32 (Debounce)</td>
<td>30 ms</td>
</tr>
<tr>
<td>ESP32 → Serial TX</td>
<td>&lt; 1 ms</td>
</tr>
<tr>
<td>Serial → Server</td>
<td>&lt; 1 ms</td>
</tr>
<tr>
<td>Server → WebSocket</td>
<td>&lt; 1 ms</td>
</tr>
<tr>
<td>Browser → Audio Start</td>
<td>5-50 ms (gecached: ~5 ms)</td>
</tr>
<tr>
<td><strong>Gesamt (Preloaded)</strong></td>
<td><strong>~40 ms</strong></td>
</tr>
<tr>
<td><strong>Gesamt (Nicht gecached)</strong></td>
<td><strong>~200 ms</strong></td>
</tr>
</tbody>
</table>
<p>Das Medien-Preloading im Browser reduziert die Latenz erheblich.</p>
<hr />
<p><em>Stand: 2026-01-08 | Version 2.5.2</em></p>
</div>
</body>
</html>
