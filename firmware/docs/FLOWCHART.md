# Flussdiagramme

Programmablaufplaene (PAP) fuer die Selection Panel Firmware.

## System-Startup

```
                    ┌─────────────┐
                    │   RESET     │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ setup()     │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ delay(1500) │  USB-CDC stabilisieren
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ xQueueCreate│  Log-Queue (32 Events)
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
       ┌─────────────┐          ┌─────────────┐
       │start_io_task│          │start_serial │
       │  (Prio 5)   │          │_task (Prio 2)│
       └──────┬──────┘          └──────┬──────┘
              │                         │
              ▼                         ▼
       ┌─────────────┐          ┌─────────────┐
       │  IO-Task    │          │ Serial-Task │
       │  (Core 1)   │          │  (Core 1)   │
       └─────────────┘          └─────────────┘
              │                         │
              └────────────┬────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   loop()    │
                    │vTaskDelay(∞)│
                    └─────────────┘
```

## IO-Task Hauptschleife

```
┌──────────────────────────────────────────────────────────────────┐
│                        io_task_function()                        │
└──────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │    Initialisierung  │
                    │  SPI, GPIO, Module  │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┴──────────────────────┐
        │                                             │
        │  ┌───────────────────────────────────────┐  │
        │  │         HAUPTSCHLEIFE (200 Hz)        │  │
        │  └───────────────────────────────────────┘  │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ vTaskDelayUntil(5ms)│           │
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ process_led_commands│  ◄── Queue vom Serial-Task
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │  CD4021B readRaw()  │  Taster einlesen
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ Debouncer.update()  │  Entprellen
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ Selection.update()  │  Auswahl bestimmen
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │  LED-Zustand bauen  │  One-Hot oder Remote
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │   HC595 write()     │  LEDs aktualisieren
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ xQueueSend(log_event)│ ──► Queue zum Serial-Task
        │           └──────────┬──────────┘           │
        │                      │                      │
        └──────────────────────┴──────────────────────┘
```

## Debounce-Algorithmus

```
                    ┌─────────────────────┐
                    │ Debouncer.update()  │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Fuer jeden Taster  │
                    │    id = 1..10       │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ raw_now = aktueller │
                    │    Rohwert          │
                    └──────────┬──────────┘
                               │
                               ▼
                  ┌────────────────────────┐
                  │ raw_now != raw_prev ?  │
                  └─────────┬──────────────┘
                            │
              ┌─────────────┴─────────────┐
              │ JA                        │ NEIN
              ▼                           ▼
    ┌─────────────────────┐    ┌─────────────────────┐
    │ _last_change[id] =  │    │   (unveraendert)    │
    │      now_ms         │    │                     │
    └──────────┬──────────┘    └──────────┬──────────┘
               │                          │
               └────────────┬─────────────┘
                            │
                            ▼
              ┌────────────────────────────┐
              │ now_ms - _last_change[id]  │
              │      >= DEBOUNCE_MS ?      │
              └─────────────┬──────────────┘
                            │
              ┌─────────────┴─────────────┐
              │ JA                        │ NEIN
              ▼                           ▼
    ┌─────────────────────┐    ┌─────────────────────┐
    │ raw_now != deb_now ?│    │   (warten)          │
    └──────────┬──────────┘    └─────────────────────┘
               │
         ┌─────┴─────┐
         │ JA        │ NEIN
         ▼           ▼
┌─────────────────┐  │
│ deb[id] = raw   │  │
│ any_changed=true│  │
└────────┬────────┘  │
         │           │
         └─────┬─────┘
               │
               ▼
    ┌─────────────────────┐
    │ _raw_prev = raw     │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ return any_changed  │
    └─────────────────────┘
```

## Selection-Algorithmus

```
                    ┌─────────────────────┐
                    │ Selection.update()  │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ new_active = active │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Fuer jeden Taster  │
                    │    id = 1..10       │
                    └──────────┬──────────┘
                               │
                               ▼
              ┌────────────────────────────┐
              │  now_pressed && !prev_     │
              │       pressed ?            │  Steigende Flanke?
              └─────────────┬──────────────┘
                            │
              ┌─────────────┴─────────────┐
              │ JA                        │ NEIN
              ▼                           ▼
    ┌─────────────────────┐    ┌─────────────────────┐
    │  new_active = id    │    │   (kein Wechsel)    │
    │  "Last press wins"  │    │                     │
    └──────────┬──────────┘    └──────────┬──────────┘
               │                          │
               └────────────┬─────────────┘
                            │
                            ▼
              ┌────────────────────────────┐
              │   !LATCH_SELECTION &&      │
              │   !any_pressed(deb) ?      │
              └─────────────┬──────────────┘
                            │
              ┌─────────────┴─────────────┐
              │ JA                        │ NEIN
              ▼                           ▼
    ┌─────────────────────┐    ┌─────────────────────┐
    │  new_active = 0     │    │   (beibehalten)     │
    │  Auswahl loeschen   │    │                     │
    └──────────┬──────────┘    └──────────┬──────────┘
               │                          │
               └────────────┬─────────────┘
                            │
                            ▼
                    ┌─────────────────────┐
                    │ _deb_prev = deb_now │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ active_id = new_    │
                    │        active       │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │return (active_id != │
                    │      prev_active)   │
                    └─────────────────────┘
```

## Serial-Task

```
┌──────────────────────────────────────────────────────────────────┐
│                      serial_task_function()                      │
└──────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ Serial.begin(115200)│
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │   send "READY"      │
                    │   send "FW ..."     │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┴──────────────────────┐
        │                                             │
        │  ┌───────────────────────────────────────┐  │
        │  │            HAUPTSCHLEIFE              │  │
        │  └───────────────────────────────────────┘  │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │ read_serial_input() │  Befehle vom Pi
        │           └──────────┬──────────┘           │
        │                      │                      │
        │                      ▼                      │
        │           ┌─────────────────────┐           │
        │           │xQueueReceive(10ms)  │  ◄── Queue vom IO-Task
        │           └──────────┬──────────┘           │
        │                      │                      │
        │            ┌─────────┴─────────┐            │
        │            │ Event?            │            │
        │            └─────────┬─────────┘            │
        │                      │                      │
        │         ┌────────────┴────────────┐         │
        │         │ JA                      │ NEIN    │
        │         ▼                         ▼         │
        │  ┌─────────────────┐    ┌─────────────────┐ │
        │  │ active_changed? │    │    (warten)     │ │
        │  └────────┬────────┘    └─────────────────┘ │
        │           │                                 │
        │     ┌─────┴─────┐                           │
        │     │ JA        │ NEIN                      │
        │     ▼           ▼                           │
        │ ┌────────┐  ┌────────┐                      │
        │ │PRESS   │  │RELEASE │                      │
        │ │oder    │  │(wenn   │                      │
        │ │RELEASE │  │noetig) │                      │
        │ └───┬────┘  └───┬────┘                      │
        │     │           │                           │
        │     └─────┬─────┘                           │
        │           │                                 │
        └───────────┴─────────────────────────────────┘
```

## LED-Befehlsverarbeitung

```
                    ┌─────────────────────┐
                    │ process_command()   │  ◄── Befehl vom Pi
                    └──────────┬──────────┘
                               │
                               ▼
              ┌────────────────────────────┐
              │      Befehl parsen         │
              └─────────────┬──────────────┘
                            │
        ┌───────┬───────┬───┴───┬───────┬───────┐
        │       │       │       │       │       │
        ▼       ▼       ▼       ▼       ▼       ▼
     LEDSET  LEDON  LEDOFF  LEDCLR  LEDALL  andere
        │       │       │       │       │       │
        ▼       ▼       ▼       ▼       ▼       ▼
    ┌───────────────────────────────────────────────┐
    │           led_control_callback()              │
    └────────────────────┬──────────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │ xQueueSend(led_cmd) │  ──► Queue zum IO-Task
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │    send_ok()        │  "OK" zurueck
              └─────────────────────┘


                    ┌─────────────────────┐
                    │process_led_commands │  ◄── IO-Task
                    └──────────┬──────────┘
                               │
                               ▼
              ┌────────────────────────────┐
              │  xQueueReceive(led_cmd)    │
              └─────────────┬──────────────┘
                            │
        ┌───────┬───────┬───┴───┬───────┐
        │       │       │       │       │
        ▼       ▼       ▼       ▼       ▼
   LED_CMD_ LED_CMD_ LED_CMD_ LED_CMD_ LED_CMD_
     SET      ON      OFF     CLEAR    ALL
        │       │       │       │       │
        ▼       ▼       ▼       ▼       ▼
    ┌───────┐ ┌───┐  ┌────┐ ┌─────┐ ┌─────┐
    │One-Hot│ │Bit│  │Bit │ │Alle │ │Alle │
    │ LED   │ │set│  │clr │ │ aus │ │ an  │
    └───────┘ └───┘  └────┘ └─────┘ └─────┘
        │       │       │       │       │
        └───────┴───────┴───┬───┴───────┘
                            │
                            ▼
              ┌─────────────────────┐
              │  _remote_mode=true  │  (ausser CLEAR)
              └─────────────────────┘
```

## CD4021B Lesevorgang

```
                    ┌─────────────────────┐
                    │   Cd4021::readRaw() │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  PS = HIGH          │  Parallel Load
                    │  delay 5us          │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  PS = LOW           │  Shift Mode
                    │  delay 1us          │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  first_bit =        │  ◄── KRITISCH!
                    │  digitalRead(MISO)  │  First-Bit vor SPI
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  SpiGuard(MODE1)    │
                    │  SPI.transfer(0x00) │  BTN_BYTES mal
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Bit-Korrektur:     │
                    │  first_bit als MSB  │
                    │  rx[] um 1 shiften  │
                    └─────────────────────┘
```

## HC595 Schreibvorgang

```
                    ┌─────────────────────┐
                    │   Hc595::write()    │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  maskUnused()       │  Ghost-Bits loeschen
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  SpiGuard(MODE0)    │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  for i = LED_BYTES  │
                    │      downto 0:      │  Letztes Byte zuerst!
                    │  SPI.transfer(      │
                    │     state[i])       │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  latch():           │
                    │  RCK = HIGH         │
                    │  delay 1us          │
                    │  RCK = LOW          │
                    └─────────────────────┘
```
